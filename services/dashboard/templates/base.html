<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}Academoscope{% endblock %}</title>
    <!-- Bootswatch Flatly theme (Bootstrap 5) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/flatly/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Custom fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome для иконок -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- AOS (анимации при скролле) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      body {
        position: relative;
        min-height: 100vh;
        overflow-x: hidden;
        transition: background-color 0.3s ease, color 0.3s ease;
        font-family: "Manrope", "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        z-index: -1;
        transition: opacity 0.3s ease, background 0.3s ease;
      }

      body.theme-light {
        background-color: #f5f5f7;
        color: #111827;
      }

      body.theme-light::before {
        background: radial-gradient(circle at 0% 0%, #18bc9c1a 0, transparent 45%),
          radial-gradient(circle at 100% 100%, #3498db1a 0, transparent 50%),
          linear-gradient(135deg, #ecf4fb 0%, #ffffff 50%, #f5f5f7 100%);
        opacity: 1;
      }

      body.theme-dark {
        background-color: #0f172a;
        color: #e5e7eb;
      }

      body.theme-dark::before {
        background: radial-gradient(circle at 0% 0%, #18bc9c33 0, transparent 45%),
          radial-gradient(circle at 100% 100%, #3498db33 0, transparent 50%),
          radial-gradient(circle at 0% 100%, #9b59b633 0, transparent 45%),
          linear-gradient(135deg, #0f172a 0%, #111827 50%, #020617 100%);
        opacity: 1;
        animation: bg-move 30s ease-in-out infinite alternate;
      }

      @keyframes bg-move {
        0% {
          transform: translate3d(0, 0, 0) scale(1);
        }
        50% {
          transform: translate3d(-10px, -10px, 0) scale(1.02);
        }
        100% {
          transform: translate3d(10px, 10px, 0) scale(1.03);
        }
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6,
      .navbar-brand {
        font-family: "Space Grotesk", system-ui, -apple-system,
          BlinkMacSystemFont, "Segoe UI", sans-serif;
        letter-spacing: 0.02em;
      }

      .metric-card {
        border: none;
        background: rgba(255, 255, 255, 0.96);
        box-shadow: 0 0.75rem 1.5rem rgba(15, 23, 42, 0.12);
        transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
      }

      .metric-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 1.25rem 2.5rem rgba(15, 23, 42, 0.18);
      }

      body.theme-dark .metric-card {
        background: rgba(15, 23, 42, 0.96);
        box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.6);
      }

      body.theme-dark .metric-card,
      body.theme-dark .metric-card * {
        color: #e5e7eb;
      }

      body.theme-dark .btn-outline-secondary {
        color: #e5e7eb;
        border-color: rgba(148, 163, 184, 0.8);
      }

      body.theme-dark .btn-outline-secondary:hover,
      body.theme-dark .btn-outline-secondary.active {
        background-color: #18bc9c;
        color: #0f172a;
        border-color: #18bc9c;
      }

      body.theme-light .btn-outline-secondary {
        color: #374151;
        border-color: #cbd5e1;
      }

      body.theme-light .btn-outline-secondary:hover,
      body.theme-light .btn-outline-secondary.active {
        background-color: #18bc9c;
        color: #ffffff;
        border-color: #18bc9c;
      }
 
      body.theme-dark .text-muted {
        color: #9ca3af !important;
      }

      body.theme-dark .table {
        color: #e5e7eb;
        background-color: transparent;
      }

      body.theme-dark .table th,
      body.theme-dark .table td {
        color: #e5e7eb;
      }

      body.theme-dark .table thead th {
        border-bottom-color: rgba(148, 163, 184, 0.6) !important;
        background-color: #111827 !important;
      }

      body.theme-dark .table > :not(caption) > * > * {
        border-color: rgba(55, 65, 81, 0.9) !important;
      }

      body.theme-dark .table tbody > tr > * {
        background-color: rgba(15, 23, 42, 0.9) !important;
      }

      body.theme-dark .table tbody > tr:nth-of-type(even) > * {
        background-color: rgba(15, 23, 42, 0.85) !important;
      }

      body.theme-dark .badge.bg-light,
      body.theme-dark .badge.bg-light.text-dark {
        background-color: rgba(15, 23, 42, 0.9) !important;
        color: #e5e7eb !important;
        border: 1px solid rgba(148, 163, 184, 0.6) !important;
      }

      .table a {
        position: relative;
        text-decoration: none;
        font-weight: 500;
        color: inherit;
        transition: color 0.2s ease, transform 0.18s ease, box-shadow 0.18s ease;
      }

      .table a:hover {
        text-decoration: none;
        transform: translateY(-1px);
      }

      body.theme-light .table a {
        color: #2c3e50;
      }

      body.theme-light .table a:hover {
        color: #18bc9c;
      }

      body.theme-dark .table a {
        color: #e5e7eb;
      }

      body.theme-dark .table a:hover {
        color: #18bc9c;
      }

      .acad-table-scroll {
        max-height: 360px;
        overflow-y: auto;
      }

      .acad-table-scroll table {
        margin-bottom: 0;
      }

      body.theme-dark .donut-legend-label {
        color: #e5e7eb;
      }

      .acad-back-btn {
        border-radius: 999px;
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        border-width: 1px;
      }

      body.theme-light .acad-back-btn {
        border-color: rgba(148, 163, 184, 0.6);
        color: #374151;
        background-color: #ffffff;
      }

      body.theme-light .acad-back-btn:hover {
        background-color: #f3f4f6;
        color: #111827;
      }

      body.theme-dark .acad-back-btn {
        border-color: rgba(148, 163, 184, 0.7);
        color: #e5e7eb;
        background-color: rgba(15, 23, 42, 0.9);
      }

      body.theme-dark .acad-back-btn:hover {
        background-color: rgba(31, 41, 55, 0.9);
        color: #f9fafb;
      }

      #ai-insights.ai-highlight {
        box-shadow: 0 0 0 0.25rem rgba(24, 188, 156, 0.35);
        border-radius: 0.75rem;
        transition: box-shadow 0.3s ease, transform 0.3s ease;
        transform: translateY(-2px);
      }

      body.theme-dark #ai-insights.ai-highlight {
        box-shadow: 0 0 0 0.25rem rgba(56, 189, 248, 0.45);
      }
    </style>
  </head>
  <body class="theme-light">
    <nav class="navbar navbar-expand-lg navbar-dark mb-4" style="background: linear-gradient(90deg, #2c3e50, #18bc9c);">
      <div class="container-fluid">
        <a class="navbar-brand fw-semibold" href="/">
          <i class="fa-solid fa-chart-line me-2"></i>
          Academoscope
        </a>
        <div class="d-flex align-items-center gap-3">
          <span
            class="navbar-text d-none d-md-inline text-light-50"
            data-i18n-key="nav.tagline"
          >
            Аналитический центр для онлайн-курсов
          </span>
          <div
            class="btn-group btn-group-sm d-none d-sm-inline-flex"
            role="group"
            aria-label="Language switcher"
          >
            <button
              type="button"
              class="btn btn-outline-light"
              data-lang-option
              data-lang="ru"
            >
              RU
            </button>
            <button
              type="button"
              class="btn btn-outline-light"
              data-lang-option
              data-lang="en"
            >
              EN
            </button>
          </div>
          <button
            class="btn btn-sm btn-outline-light position-relative"
            type="button"
            data-ai-scroll
          >
            <i class="fa-solid fa-brain me-1"></i>
            <span
              class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
            >
              0
            </span>
          </button>
          <button
            class="btn btn-sm btn-outline-light rounded-pill"
            type="button"
            data-theme-toggle
          >
            <i class="fa-solid fa-moon" data-theme-toggle-icon></i>
          </button>
        </div>
      </div>
    </nav>

    <main class="container mb-5" data-current-period="{{ period|default('all') }}">
      {% block content %}{% endblock %}
    </main>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const THEME_KEY = "acad_theme";
        const LANG_KEY = "acad_lang";

        const I18N = {
          ru: {
            "nav.tagline": "Аналитический центр для онлайн-курсов",
            "common.period": "Период:",
            "period.all": "Всё время",
            "period.7d": "7 дней",
            "period.30d": "30 дней",
            "period.label_prefix": "Показатели",
            "index.title": "Курсы",
            "index.metric.courses": "Курсов",
            "index.metric.total_students": "Студентов всего",
            "index.metric.completed_prefix": "Завершили:",
            "index.metric.reach": "Общий охват",
            "index.metric.reach_active_prefix": "Активных за 30 дней:",
            "index.metric.revenue": "Выручка (MRR / ARR)",
            "index.metric.revenue_hint":
              "Подключите биллинг, чтобы видеть выручку.",
            "index.metric.churn": "Прогнозируемый отток",
            "index.metric.churn_hint":
              "Появится после подключения модуля прогнозной аналитики.",
            "index.metric.avg_completion":
              "Средний процент завершения по всем курсам",
            "index.chart.completion_title": "Процент завершения по курсам",
            "index.chart.completion_badge_all": "по всем данным",
            "index.chart.donut_title": "Завершённость студентов",
            "index.donut.legend.completed_label": "Завершили:",
            "index.donut.legend.not_completed_label": "Не завершили:",
            "index.table.course": "Курс",
            "index.table.students": "Студентов",
            "index.table.completed": "Завершили",
            "index.table.completion_rate": "Процент завершения",
            "index.empty":
              "Пока нет данных. Отправьте несколько тестовых событий через API Gateway.",
            "index.export.csv": "Экспорт в CSV",
            "index.export.pdf": "Экспорт в PDF",
            "index.section.behavior_title": "Как учатся ваши студенты",
            "index.section.finance_title": "Финансовая и маркетинговая аналитика",
            "index.section.ai_title": "Academoscope AI Insights",
            "index.behavior.retention_map": "Карта удержания по урокам",
            "index.behavior.retention_map_desc":
              "График и таблица отсева по урокам на странице курса.",
            "index.behavior.content_activity": "Топ-5 самых популярных уроков",
            "index.behavior.content_activity_desc":
              "Показывает уроки с наибольшим числом начавших их студентов.",
            "index.behavior.time_distribution": "Распределение прогресса по курсам",
            "index.behavior.time_distribution_desc":
              "Показывает, сколько курсов попадает в каждый диапазон процента завершения.",
            "index.behavior.top_rewatched":
              "Топ-5 сложных уроков (по оттоку)",
            "index.behavior.top_rewatched_desc":
              "Помогает увидеть уроки с наибольшим оттоком: много студентов начинают, но не завершают.",
            "index.behavior.popular_lessons_empty":
              "Пока недостаточно данных, чтобы показать популярные уроки.",
            "index.behavior.difficult_lessons_empty":
              "Пока недостаточно данных, чтобы показать сложные уроки.",
            "index.behavior.progress_distribution_empty":
              "Пока недостаточно данных для распределения прогресса по курсам.",
            "index.behavior.progress_bucket_0_25_label":
              "0–25% завершения",
            "index.behavior.progress_bucket_25_50_label":
              "25–50% завершения",
            "index.behavior.progress_bucket_50_75_label":
              "50–75% завершения",
            "index.behavior.progress_bucket_75_100_label":
              "75–100% завершения",
            "index.finance.channels": "Эффективность каналов привлечения",
            "index.finance.channels_desc":
              "Здесь будет таблица с каналами, конверсией, % завершения и LTV.",
            "index.finance.sales_refunds": "Динамика продаж и возвратов",
            "index.finance.sales_refunds_desc":
              "Линейный график продаж и возвратов по дням или неделям.",
            "index.finance.ltv": "Средняя ценность студента (LTV)",
            "index.finance.ltv_desc":
              "Появится после подключения биллинга и данных о выручке.",
            "index.ai.risk_students": "Студенты группы риска",
            "index.ai.risk_students_desc":
              "Список студентов, которые с высокой вероятностью не завершат курс.",
            "index.ai.recommendations": "Рекомендации по улучшению курса",
            "index.ai.recommendations_desc":
              "Автоматические инсайты на основе поведения студентов.",
            "index.ai.risk_students_empty":
              "Пока нет студентов в группе риска по текущим данным.",
            "index.badge.available_now": "Уже доступно",
            "index.badge.soon": "Скоро",
            "index.badge.demo": "Демо",
            "course.period_label": "Период:",
            "course.metric.total_students": "Студентов всего",
            "course.metric.completed_students": "Завершили курс",
            "course.metric.completion_rate": "Процент завершения курса",
            "course.chart.dropoff_title": "График удержания по урокам",
            "course.table.title": "Удержание по урокам",
            "course.table.column_lesson": "Урок",
            "course.table.column_started": "Начали",
            "course.table.column_completed": "Завершили",
            "course.table.column_dropoff": "Отток",
            "course.empty_lessons":
              "Ещё нет событий по урокам этого курса.",
            "students.title": "Студенты",
            "students.table.student": "Студент",
            "students.table.status": "Статус",
            "students.table.courses": "Курсы",
            "students.table.first_seen": "Дата регистрации",
            "students.table.last_seen": "Последний визит",
            "students.empty": "Пока нет студентов в этой выборке.",
            "students.search.placeholder": "Поиск по имени или email",
            "student.metric.registration_date": "Дата регистрации",
            "student.metric.last_visit": "Последний визит",
            "student.metric.overall_progress": "Общий прогресс по курсам",
            "student.section.courses": "Курсы и детальная активность",
            "student.courses.progress_label": "Прогресс",
            "student.courses.last_visit_label": "Последний визит:",
            "student.courses.empty": "Пока нет данных по курсам этого студента.",
            "student.section.activity_timeline": "Временная шкала активности",
            "student.section.activity_timeline_empty": "Пока нет событий, чтобы построить временную шкалу.",
            "student.section.insights_title": "Инсайты и теги Academoscope",
            "student.section.auto_tags_title": "Автоматические метки",
            "student.section.auto_tags_empty": "Пока нет достаточных данных для формирования меток.",
            "student.status.active": "Активен",
            "student.status.inactive": "Неактивен",
            "student.status.risk": "В группе риска",
            "student.status.no_data": "Нет данных",
            "index.metric.students_list_title": "Карточки студентов",
            "index.metric.students_list_cta": "Открыть список",
            "index.metric.students_list_hint":
              "Перейдите к полному списку студентов и их карточкам.",
            "behavior.title": "Поведенческая аналитика",
            "behavior.popular_title": "Топ-уроков по популярности",
            "behavior.difficult_title": "Топ-уроков по сложности (отток)",
            "behavior.progress_title": "Распределение прогресса по курсам",
            "behavior.table.course": "Курс",
            "behavior.table.lesson": "Урок",
            "behavior.table.started": "Начали",
            "behavior.table.completed": "Завершили",
            "behavior.table.dropoff": "Отток",
            "behavior.table.progress_band": "Диапазон прогресса",
            "behavior.table.courses_count": "Курсов",
            "behavior.empty":
              "Пока недостаточно данных для поведенческой аналитики.",
            "behavior.open_full": "Открыть развёрнутую аналитику",
          },
          en: {
            "nav.tagline": "Analytics hub for online courses",
            "common.period": "Period:",
            "period.all": "All time",
            "period.7d": "7 days",
            "period.30d": "30 days",
            "period.label_prefix": "Metrics",
            "index.title": "Courses",
            "index.metric.courses": "Courses",
            "index.metric.total_students": "Total students",
            "index.metric.completed_prefix": "Completed:",
            "index.metric.reach": "Reach",
            "index.metric.reach_active_prefix": "Active in last 30 days:",
            "index.metric.revenue": "Revenue (MRR / ARR)",
            "index.metric.revenue_hint":
              "Connect billing to see revenue.",
            "index.metric.churn": "Predicted churn",
            "index.metric.churn_hint":
              "Will appear once predictive module is enabled.",
            "index.metric.avg_completion":
              "Average completion rate across courses",
            "index.chart.completion_title": "Course completion rate",
            "index.chart.completion_badge_all": "all data",
            "index.chart.donut_title": "Student completion",
            "index.donut.legend.completed_label": "Completed:",
            "index.donut.legend.not_completed_label": "Not completed:",
            "index.table.course": "Course",
            "index.table.students": "Students",
            "index.table.completed": "Completed",
            "index.table.completion_rate": "Completion rate",
            "index.empty":
              "No data yet. Send some test events through the API Gateway.",
            "index.export.csv": "Export to CSV",
            "index.export.pdf": "Export to PDF",
            "index.section.behavior_title": "How your students learn",
            "index.section.finance_title":
              "Financial and marketing analytics",
            "index.section.ai_title": "Academoscope AI Insights",
            "index.behavior.retention_map": "Lesson retention map",
            "index.behavior.retention_map_desc":
              "See drop-off chart and table on the course detail page.",
            "index.behavior.content_activity": "Top-5 most popular lessons",
            "index.behavior.content_activity_desc":
              "Shows lessons with the highest number of students who started them.",
            "index.behavior.time_distribution": "Course progress distribution",
            "index.behavior.time_distribution_desc":
              "Shows how many courses fall into each completion band.",
            "index.behavior.top_rewatched": "Top-5 difficult lessons (by drop-off)",
            "index.behavior.top_rewatched_desc":
              "Helps you spot lessons with the highest drop-off: many start, few finish.",
            "index.behavior.popular_lessons_empty":
              "Not enough data yet to show popular lessons.",
            "index.behavior.difficult_lessons_empty":
              "Not enough data yet to show difficult lessons.",
            "index.behavior.progress_distribution_empty":
              "Not enough data yet to build a course progress distribution.",
            "index.behavior.progress_bucket_0_25_label":
              "0–25% completion",
            "index.behavior.progress_bucket_25_50_label":
              "25–50% completion",
            "index.behavior.progress_bucket_50_75_label":
              "50–75% completion",
            "index.behavior.progress_bucket_75_100_label":
              "75–100% completion",
            "index.finance.channels": "Acquisition channel performance",
            "index.finance.channels_desc":
              "Table of channels with conversion, completion % and LTV.",
            "index.finance.sales_refunds": "Sales and refunds dynamics",
            "index.finance.sales_refunds_desc":
              "Line chart of sales and refunds by day or week.",
            "index.finance.ltv": "Average student LTV",
            "index.finance.ltv_desc":
              "Will appear after billing data is connected.",
            "index.ai.risk_students": "Students at risk",
            "index.ai.risk_students_desc":
              "List of students likely to drop out before completion.",
            "index.ai.recommendations": "Course improvement suggestions",
            "index.ai.recommendations_desc":
              "Automated insights based on student behavior.",
            "index.ai.risk_students_empty":
              "No students at risk for the current data yet.",
            "index.badge.available_now": "Available now",
            "index.badge.soon": "Coming soon",
            "index.badge.demo": "Demo",
            "course.period_label": "Period:",
            "course.metric.total_students": "Total students",
            "course.metric.completed_students": "Course completions",
            "course.metric.completion_rate": "Completion rate",
            "course.chart.dropoff_title": "Lesson retention chart",
            "course.table.title": "Lesson retention",
            "course.table.column_lesson": "Lesson",
            "course.table.column_started": "Started",
            "course.table.column_completed": "Completed",
            "course.table.column_dropoff": "Drop-off",
            "course.empty_lessons":
              "No lesson events for this course yet.",
            "students.title": "Students",
            "students.table.student": "Student",
            "students.table.status": "Status",
            "students.table.courses": "Courses",
            "students.table.first_seen": "Registration date",
            "students.table.last_seen": "Last visit",
            "students.empty": "No students in this selection yet.",
            "students.search.placeholder": "Search by name or email",
            "student.metric.registration_date": "Registration date",
            "student.metric.last_visit": "Last visit",
            "student.metric.overall_progress": "Overall course progress",
            "student.section.courses": "Courses and detailed activity",
            "student.courses.progress_label": "Progress",
            "student.courses.last_visit_label": "Last visit:",
            "student.courses.empty": "No course data for this student yet.",
            "student.section.activity_timeline": "Activity timeline",
            "student.section.activity_timeline_empty": "No events yet to build a timeline.",
            "student.section.insights_title": "Academoscope insights and tags",
            "student.section.auto_tags_title": "Automatic tags",
            "student.section.auto_tags_empty":
              "Not enough data yet to generate tags.",
            "student.status.active": "Active",
            "student.status.inactive": "Inactive",
            "student.status.risk": "At risk",
            "student.status.no_data": "No data",
            "index.metric.students_list_title": "Student cards",
            "index.metric.students_list_cta": "Open list",
            "index.metric.students_list_hint":
              "Go to the full list of students and their profiles.",
            "behavior.title": "Behavior analytics",
            "behavior.popular_title": "Top lessons by popularity",
            "behavior.difficult_title": "Top lessons by difficulty (drop-off)",
            "behavior.progress_title": "Course progress distribution",
            "behavior.table.course": "Course",
            "behavior.table.lesson": "Lesson",
            "behavior.table.started": "Started",
            "behavior.table.completed": "Completed",
            "behavior.table.dropoff": "Drop-off",
            "behavior.table.progress_band": "Progress band",
            "behavior.table.courses_count": "Courses",
            "behavior.empty":
              "Not enough data yet for behavior analytics.",
            "behavior.open_full": "Open full behavior analytics",
          },
        };

        const PERIOD_LABELS = {
          ru: {
            all: "за всё время",
            "7d": "за последние 7 дней",
            "30d": "за последние 30 дней",
          },
          en: {
            all: "for all time",
            "7d": "for the last 7 days",
            "30d": "for the last 30 days",
          },
        };

        let currentLang = "ru";

        function applyTheme(theme) {
          const body = document.body;
          body.classList.remove("theme-light", "theme-dark");
          const normalized = theme === "dark" ? "theme-dark" : "theme-light";
          body.classList.add(normalized);

          const icon = document.querySelector("[data-theme-toggle-icon]");
          if (icon) {
            icon.classList.remove("fa-moon", "fa-sun");
            icon.classList.add(theme === "dark" ? "fa-sun" : "fa-moon");
          }

          window.dispatchEvent(
            new CustomEvent("acad-theme-changed", { detail: { theme } }),
          );
        }

        function applyTranslations(lang) {
          const dict = I18N[lang] || I18N.ru;
          document.querySelectorAll("[data-i18n-key]").forEach((el) => {
            const key = el.dataset.i18nKey;
            const value = dict[key];
            if (value) {
              el.textContent = value;
            }
          });
        }

        function getCurrentPeriod() {
          const mainEl = document.querySelector("main[data-current-period]");
          return (mainEl && mainEl.dataset.currentPeriod) || "all";
        }

        function setCurrentPeriod(period) {
          const mainEl = document.querySelector("main[data-current-period]");
          if (mainEl) {
            mainEl.dataset.currentPeriod = period;
          }
        }

        function updatePeriodLabels() {
          const lang = currentLang === "en" ? "en" : "ru";
          const dict = I18N[lang] || I18N.ru;
          const labels = PERIOD_LABELS[lang] || PERIOD_LABELS.ru;
          const period = getCurrentPeriod();
          const label = labels[period] || labels.all;
          const prefix =
            (dict && dict["period.label_prefix"]) ||
            (lang === "en" ? "Metrics" : "Показатели");
          const text = `${prefix} ${label}.`;
          document.querySelectorAll(".js-period-label").forEach((el) => {
            el.textContent = text;
          });
        }

        function applyLanguage(lang) {
          const normalized = lang === "en" ? "en" : "ru";
          currentLang = normalized;
          document.documentElement.setAttribute(
            "lang",
            normalized === "en" ? "en" : "ru",
          );
          localStorage.setItem(LANG_KEY, normalized);
          applyTranslations(normalized);

          document.querySelectorAll("[data-lang-option]").forEach((btn) => {
            const btnLang = btn.getAttribute("data-lang");
            const isActive = btnLang === normalized;
            btn.classList.toggle("active", isActive);
            btn.setAttribute("aria-pressed", isActive ? "true" : "false");
          });

          const locale = normalized === "en" ? "en-US" : "ru-RU";
          window.dispatchEvent(
            new CustomEvent("acad-lang-changed", {
              detail: { lang: normalized, locale },
            }),
          );

          updatePeriodLabels();
        }

        let theme = localStorage.getItem(THEME_KEY);
        if (theme !== "dark" && theme !== "light") {
          theme = "light";
        }
        applyTheme(theme);

        let savedLang = localStorage.getItem(LANG_KEY);
        if (savedLang !== "ru" && savedLang !== "en") {
          savedLang = "ru";
        }
        applyLanguage(savedLang);

        const themeToggle = document.querySelector("[data-theme-toggle]");
        if (themeToggle) {
          themeToggle.addEventListener("click", function (event) {
            event.preventDefault();
            theme = theme === "dark" ? "light" : "dark";
            localStorage.setItem(THEME_KEY, theme);
            applyTheme(theme);
          });
        }

        document.querySelectorAll("[data-lang-option]").forEach((btn) => {
          btn.addEventListener("click", function (event) {
            event.preventDefault();
            const newLang = btn.getAttribute("data-lang") || "ru";
            applyLanguage(newLang);
          });
        });

        if (window.AOS) {
          window.AOS.init({
            once: true,
            duration: 600,
            easing: "ease-out-cubic",
            offset: 40,
          });
        }

        function highlightAiSection(target) {
          if (!target) return;
          target.classList.remove("ai-highlight");
          void target.offsetWidth;
          target.classList.add("ai-highlight");
          setTimeout(() => {
            target.classList.remove("ai-highlight");
          }, 1600);
        }

        const aiScrollBtn = document.querySelector("[data-ai-scroll]");
        if (aiScrollBtn) {
          aiScrollBtn.addEventListener("click", function (event) {
            event.preventDefault();

            const existingTarget = document.querySelector("#ai-insights");
            if (existingTarget) {
              existingTarget.scrollIntoView({ behavior: "smooth", block: "start" });
              highlightAiSection(existingTarget);
              return;
            }

            const url = new URL("/", window.location.origin);
            loadPage(url.toString(), true).then(() => {
              const target = document.querySelector("#ai-insights");
              if (target) {
                target.scrollIntoView({ behavior: "smooth", block: "start" });
                highlightAiSection(target);
              }
            });
          });
        }

        function initCounters() {
          const counters = document.querySelectorAll("[data-countup-target]");
          const currentLocale = currentLang === "en" ? "en-US" : "ru-RU";
          counters.forEach((el) => {
            const target = Number(el.dataset.countupTarget);
            if (!Number.isFinite(target)) return;
            const suffix = el.dataset.countupSuffix || "";

            const startValue = 0;
            const duration = 800;
            const startTime = performance.now();

            function animate(now) {
              const progress = Math.min((now - startTime) / duration, 1);
              const value = Math.floor(
                startValue + (target - startValue) * progress,
              );
              el.textContent = value.toLocaleString(currentLocale) + suffix;
              if (progress < 1) {
                requestAnimationFrame(animate);
              }
            }

            requestAnimationFrame(animate);
          });
        }

        initCounters();

        window.acadSetCurrentPeriod = function (period) {
          setCurrentPeriod(period || "all");
          updatePeriodLabels();
        };

        function loadPage(url, pushStateUpdate) {
          return fetch(url, {
            method: "GET",
            credentials: "same-origin",
          })
            .then((resp) => resp.text())
            .then((html) => {
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, "text/html");

              const newMain = doc.querySelector("main[data-current-period]");
              const currentMain = document.querySelector(
                "main[data-current-period]",
              );

              if (newMain && currentMain) {
                if (newMain.dataset.currentPeriod) {
                  currentMain.dataset.currentPeriod = newMain.dataset.currentPeriod;
                } else {
                  currentMain.dataset.currentPeriod = "all";
                }
                currentMain.innerHTML = newMain.innerHTML;
              }

              const newTitle = doc.querySelector("title");
              if (newTitle) {
                document.title = newTitle.textContent;
              }

              applyTranslations(currentLang);
              updatePeriodLabels();

              if (window.AOS && window.AOS.refreshHard) {
                window.AOS.refreshHard();
              } else if (window.AOS && window.AOS.refresh) {
                window.AOS.refresh();
              }

              initCounters();

              const pageScripts = doc.querySelectorAll(
                "script[data-page-script]",
              );
              pageScripts.forEach((oldScript) => {
                const script = document.createElement("script");
                if (oldScript.src) {
                  script.src = oldScript.src;
                } else {
                  script.textContent = oldScript.textContent;
                }

                const attrNames = oldScript.getAttributeNames
                  ? oldScript.getAttributeNames()
                  : [];
                attrNames.forEach((name) => {
                  if (name === "src") return;
                  script.setAttribute(name, oldScript.getAttribute(name));
                });

                document.body.appendChild(script);
              });

              if (pushStateUpdate) {
                window.history.pushState({ url }, "", url);
              }
            })
            .catch((err) => {
              console.error("Failed to load page", err);
            });
        }

        document.addEventListener("click", function (event) {
          if (event.defaultPrevented) return;

          const anchor = event.target.closest("a");
          if (!anchor) return;

          if (anchor.hasAttribute("data-period-toggle")) return;
          if (
            anchor.target &&
            anchor.target !== "" &&
            anchor.target.toLowerCase() !== "_self"
          ) {
            return;
          }

          const href = anchor.getAttribute("href");
          if (!href || href.startsWith("#")) return;

          const isModifiedClick =
            event.metaKey ||
            event.ctrlKey ||
            event.shiftKey ||
            event.altKey ||
            event.button !== 0;
          if (isModifiedClick) return;

          const url = new URL(anchor.href, window.location.origin);
          if (url.origin !== window.location.origin) return;

          const path = url.pathname;
          const isCourseLink = path.startsWith("/courses/");
          const isStudentLink = path.startsWith("/students");
          const isIndexLink = path === "/";

          if (!isCourseLink && !isStudentLink && !isIndexLink) return;

          event.preventDefault();
          loadPage(url.toString(), true);
        });

        window.addEventListener("popstate", function (event) {
          const url = (event.state && event.state.url) || window.location.href;
          loadPage(url, false);
        });
      });
    </script>
    {% block scripts %}{% endblock %}
  </body>
</html>
