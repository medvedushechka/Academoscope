{% extends "base.html" %}

{% block title %}Students — Academoscope{% endblock %}

{% block content %}
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
    <div class="d-flex align-items-center gap-2">
      <a href="/" class="btn btn-sm acad-back-btn" aria-label="Назад">
        <i class="fa-solid fa-arrow-left"></i>
        <span class="visually-hidden">Назад</span>
      </a>
      <h1
        class="mb-0"
        data-i18n-key="students.title"
      >
        Студенты
      </h1>
    </div>
  </div>

  <p class="text-muted small mb-3 js-period-label">Показатели {{ period_label }}.</p>

  {% if students %}
    <div class="row mb-3" data-aos="fade-up">
      <div class="col-12 col-md-6 col-lg-4">
        <div class="input-group input-group-sm">
          <span class="input-group-text">
            <i class="fa-solid fa-magnifying-glass"></i>
          </span>
          <input
            type="text"
            class="form-control"
            id="studentsSearchInput"
            placeholder="Поиск по имени или email"
            data-i18n-key="students.search.placeholder"
          />
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-4 mt-2 mt-md-0">
        <div class="form-check form-switch">
          <input
            class="form-check-input"
            type="checkbox"
            id="studentsRiskToggle"
          />
          <label class="form-check-label small" for="studentsRiskToggle">
            Только студенты в группе риска
          </label>
        </div>
      </div>
    </div>

    <div class="table-responsive acad-table-scroll acad-table-scroll-full" data-aos="fade-up">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th data-i18n-key="students.table.student">Студент</th>
            <th
              class="text-center"
              id="studentsStatusHeader"
              data-i18n-key="students.table.status"
            >
              Статус
            </th>
            <th
              class="text-center"
              id="studentsCoursesHeader"
              data-i18n-key="students.table.courses"
            >
              Курсы
            </th>
            <th
              class="text-center"
              id="studentsProgressHeader"
              data-i18n-key="students.table.avg_progress"
            >
              Средний прогресс
            </th>
            <th class="text-center" data-i18n-key="students.table.first_seen">
              Дата регистрации
            </th>
            <th
              class="text-center"
              id="studentsLastSeenHeader"
              data-i18n-key="students.table.last_seen"
            >
              Последний визит
            </th>
          </tr>
        </thead>
        <tbody class="js-students-tbody">
          {% for s in students %}
            <tr
              data-search-text="{{ (s.display_name ~ ' ' ~ (s.email or '') ~ ' ' ~ s.external_id)|lower }}"
              data-status="{{ s.status_code }}"
              data-courses="{{ s.courses_count }}"
              data-progress="{{ s.overall_progress }}"
              data-last-seen="{{ s.last_seen_at or '' }}"
            >
              <td>
                <a href="/students/{{ s.id }}">{{ s.display_name }}</a>
                {% if s.email %}
                  <div class="text-muted small">{{ s.email }}</div>
                {% endif %}
              </td>
              <td class="text-center">
                <span
                  class="badge bg-{{ s.status_badge_color }}"
                  data-i18n-key="student.status.{{ s.status_code }}"
                >
                  {{ s.status_label }}
                </span>
              </td>
              <td class="text-center">
                {{ s.courses_count }}
              </td>
              <td class="text-center">
                {{ s.overall_progress }}%
              </td>
              <td class="text-center">
                {{ s.first_seen_at or "—" }}
              </td>
              <td class="text-center">
                {{ s.last_seen_at or "—" }}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p data-i18n-key="students.empty">
      Пока нет студентов в этой выборке.
    </p>
  {% endif %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script data-page-script="students-list">
    (function () {
      const input = document.getElementById("studentsSearchInput");
      const riskToggle = document.getElementById("studentsRiskToggle");
      const tbody = document.querySelector(".js-students-tbody");
      if (!input || !tbody) return;

      function applyFilter() {
        const query = input.value.trim().toLowerCase();
        const riskOnly = riskToggle && riskToggle.checked;
        const rows = tbody.querySelectorAll("tr");

        rows.forEach((row) => {
          const text = (row.getAttribute("data-search-text") || "").toLowerCase();
          const status = row.getAttribute("data-status") || "";

          const matchesQuery = !query || text.includes(query);
          const matchesRisk = !riskOnly || status === "risk";

          if (matchesQuery && matchesRisk) {
            row.classList.remove("d-none");
          } else {
            row.classList.add("d-none");
          }
        });
      }

      input.addEventListener("input", applyFilter);
      if (riskToggle) {
        riskToggle.addEventListener("change", applyFilter);
      }

      function sortRows(getValue, direction) {
        const rows = Array.from(tbody.querySelectorAll("tr"));
        rows.sort((a, b) => {
          const av = getValue(a);
          const bv = getValue(b);

          if (av === bv) return 0;
          if (av === null || av === undefined || av === "") return 1;
          if (bv === null || bv === undefined || bv === "") return -1;

          if (av < bv) return direction === "asc" ? -1 : 1;
          if (av > bv) return direction === "asc" ? 1 : -1;
          return 0;
        });

        rows.forEach((row) => tbody.appendChild(row));
      }

      const statusHeader = document.getElementById("studentsStatusHeader");
      const coursesHeader = document.getElementById("studentsCoursesHeader");
      const lastSeenHeader = document.getElementById("studentsLastSeenHeader");
      const progressHeader = document.getElementById("studentsProgressHeader");

      const statusOrder = {
        risk: 0,
        inactive: 1,
        active: 2,
        no_data: 3,
      };

      if (statusHeader) {
        let dir = "desc";
        statusHeader.style.cursor = "pointer";
        statusHeader.addEventListener("click", () => {
          sortRows((row) => {
            const code = row.getAttribute("data-status") || "no_data";
            return Object.prototype.hasOwnProperty.call(statusOrder, code)
              ? statusOrder[code]
              : 99;
          }, dir);
          dir = dir === "desc" ? "asc" : "desc";
          applyFilter();
        });
      }

      if (coursesHeader) {
        let dir = "desc";
        coursesHeader.style.cursor = "pointer";
        coursesHeader.addEventListener("click", () => {
          sortRows(
            (row) => parseInt(row.getAttribute("data-courses") || "0", 10),
            dir,
          );
          dir = dir === "desc" ? "asc" : "desc";
          applyFilter();
        });
      }

      if (progressHeader) {
        let dir = "desc";
        progressHeader.style.cursor = "pointer";
        progressHeader.addEventListener("click", () => {
          sortRows(
            (row) => parseInt(row.getAttribute("data-progress") || "0", 10),
            dir,
          );
          dir = dir === "desc" ? "asc" : "desc";
          applyFilter();
        });
      }

      if (lastSeenHeader) {
        let dir = "desc";
        lastSeenHeader.style.cursor = "pointer";
        lastSeenHeader.addEventListener("click", () => {
          sortRows(
            (row) => row.getAttribute("data-last-seen") || "",
            dir,
          );
          dir = dir === "desc" ? "asc" : "desc";
          applyFilter();
        });
      }

      applyFilter();
    })();
  </script>
{% endblock %}
