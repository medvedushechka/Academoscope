{% extends "base.html" %}

{% block title %}Students — Academoscope{% endblock %}

{% block content %}
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
    <div class="d-flex align-items-center gap-2">
      <a href="/" class="btn btn-sm acad-back-btn" aria-label="Назад">
        <i class="fa-solid fa-arrow-left"></i>
        <span class="visually-hidden">Назад</span>
      </a>
      <h1
        class="mb-0"
        data-i18n-key="students.title"
      >
        Студенты
      </h1>
    </div>
  </div>

  <p class="text-muted small mb-3 js-period-label">Показатели {{ period_label }}.</p>

  {% if students %}
    <div class="row mb-3" data-aos="fade-up">
      <div class="col-12 col-md-6 col-lg-4">
        <div class="input-group input-group-sm">
          <span class="input-group-text">
            <i class="fa-solid fa-magnifying-glass"></i>
          </span>
          <input
            type="text"
            class="form-control"
            id="studentsSearchInput"
            placeholder="Поиск по имени или email"
            data-i18n-key="students.search.placeholder"
          />
        </div>
      </div>
    </div>

    <div class="table-responsive acad-table-scroll" data-aos="fade-up">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th data-i18n-key="students.table.student">Студент</th>
            <th class="text-center" data-i18n-key="students.table.status">Статус</th>
            <th class="text-center" data-i18n-key="students.table.courses">Курсы</th>
            <th class="text-center" data-i18n-key="students.table.first_seen">Дата регистрации</th>
            <th class="text-center" data-i18n-key="students.table.last_seen">Последний визит</th>
          </tr>
        </thead>
        <tbody class="js-students-tbody">
          {% for s in students %}
            <tr
              data-search-text="{{ (s.display_name ~ ' ' ~ (s.email or '') ~ ' ' ~ s.external_id)|lower }}"
            >
              <td>
                <a href="/students/{{ s.id }}">{{ s.display_name }}</a>
                {% if s.email %}
                  <div class="text-muted small">{{ s.email }}</div>
                {% endif %}
              </td>
              <td class="text-center">
                <span
                  class="badge bg-{{ s.status_badge_color }}"
                  data-i18n-key="student.status.{{ s.status_code }}"
                >
                  {{ s.status_label }}
                </span>
              </td>
              <td class="text-center">
                {{ s.courses_count }}
              </td>
              <td class="text-center">
                {{ s.first_seen_at or "—" }}
              </td>
              <td class="text-center">
                {{ s.last_seen_at or "—" }}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p data-i18n-key="students.empty">
      Пока нет студентов в этой выборке.
    </p>
  {% endif %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script data-page-script="students-list">
    (function () {
      const input = document.getElementById("studentsSearchInput");
      if (!input) return;

      function applyFilter() {
        const query = input.value.trim().toLowerCase();
        const rows = document.querySelectorAll(".js-students-tbody tr");
        rows.forEach((row) => {
          const text = (row.getAttribute("data-search-text") || "").toLowerCase();
          if (!query || text.includes(query)) {
            row.classList.remove("d-none");
          } else {
            row.classList.add("d-none");
          }
        });
      }

      input.addEventListener("input", applyFilter);
    })();
  </script>
{% endblock %}
